{% extends 'base.html' %}

{% block title %}Dashboard - Energy Monitor{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
        </h1>
        <p class="mt-2 text-gray-600">Real-time energy monitoring and analytics</p>
    </div>

    <!-- Device Selector -->
    {% if devices %}
    <div class="mb-6 bg-white rounded-lg shadow p-4">
        <label for="deviceSelect" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-microchip mr-1"></i> Select Device
        </label>
        <select id="deviceSelect" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md">
            {% for device in devices %}
            <option value="{{ device.id }}" {% if device.id == selected_device.id %}selected{% endif %}>
                {{ device.name }}
            </option>
            {% endfor %}
        </select>
        <div class="mt-2 text-sm text-gray-500">
            <span id="deviceStatus" class="inline-flex items-center">
                <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span>
                Checking status...
            </span>
        </div>
    </div>
    {% endif %}

    <!-- Real-time Stats Cards -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-8">
        <!-- Voltage Card -->
        <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-500 truncate flex items-center">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                    Voltage
                </dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="voltageValue">--</dd>
                <dd class="mt-1 text-sm text-gray-500">Volts (V)</dd>
            </div>
        </div>

        <!-- Current Card -->
        <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-500 truncate flex items-center">
                    <i class="fas fa-plug text-blue-500 mr-2"></i>
                    Current
                </dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="currentValue">--</dd>
                <dd class="mt-1 text-sm text-gray-500">Amperes (A)</dd>
            </div>
        </div>

        <!-- Power Card -->
        <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-500 truncate flex items-center">
                    <i class="fas fa-fire text-red-500 mr-2"></i>
                    Power
                </dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="powerValue">--</dd>
                <dd class="mt-1 text-sm text-gray-500">Watts (W)</dd>
            </div>
        </div>

        <!-- Energy Card -->
        <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-500 truncate flex items-center">
                    <i class="fas fa-battery-three-quarters text-green-500 mr-2"></i>
                    Total Energy
                </dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="energyValue">--</dd>
                <dd class="mt-1 text-sm text-gray-500">kilowatt-hours (kWh)</dd>
            </div>
        </div>

        <!-- Frequency Card -->
        <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-500 truncate flex items-center">
                    <i class="fas fa-wave-square text-purple-500 mr-2"></i>
                    Frequency
                </dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="frequencyValue">--</dd>
                <dd class="mt-1 text-sm text-gray-500">Hertz (Hz)</dd>
            </div>
        </div>

        <!-- Power Factor Card -->
        <div class="bg-white overflow-hidden shadow-lg rounded-lg card-hover">
            <div class="px-4 py-5 sm:p-6">
                <dt class="text-sm font-medium text-gray-500 truncate flex items-center">
                    <i class="fas fa-percentage text-indigo-500 mr-2"></i>
                    Power Factor
                </dt>
                <dd class="mt-1 text-3xl font-semibold text-gray-900" id="pfValue">--</dd>
                <dd class="mt-1 text-sm text-gray-500">Ratio</dd>
            </div>
        </div>
    </div>

    <!-- Today's Consumption -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg shadow-lg p-6 mb-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold">Today's Consumption</h3>
                <p class="text-3xl font-bold mt-2" id="todayConsumption">-- kWh</p>
                <p class="text-sm mt-1 opacity-90">Last updated: <span id="lastUpdate">--</span></p>
            </div>
            <div class="text-6xl opacity-50">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Hourly Consumption Chart -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-clock mr-2"></i>Hourly Consumption (Today)
            </h3>
            <canvas id="hourlyChart"></canvas>
        </div>

        <!-- Weekly Consumption Chart -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-calendar-week mr-2"></i>Weekly Consumption
            </h3>
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="bg-white rounded-lg shadow-lg p-6" id="alertsSection">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>Recent Alerts
        </h3>
        <div id="alertsList">
            <p class="text-gray-500 text-center py-4">No alerts</p>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDeviceId = {{ selected_device.id|default:0 }};
let hourlyChart, weeklyChart;
let updateInterval;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (currentDeviceId) {
        initializeCharts();
        fetchDashboardData();
        startAutoUpdate();
    }
    
    // Device selector change handler
    document.getElementById('deviceSelect')?.addEventListener('change', function() {
        currentDeviceId = this.value;
        fetchDashboardData();
    });
});

// Fetch dashboard data
async function fetchDashboardData() {
    if (!currentDeviceId) return;
    
    try {
        const response = await fetch(`/api/dashboard/${currentDeviceId}/`);
        const data = await response.json();
        
        updateRealtimeData(data.latest_reading);
        updateDeviceStatus(data.device);
        updateTodayConsumption(data.today_consumption);
        updateHourlyChart(data.hourly_consumption);
        updateWeeklyChart(data.weekly_consumption);
        updateAlerts(data.alerts);
    } catch (error) {
        console.error('Error fetching dashboard data:', error);
    }
}

// Update realtime data
function updateRealtimeData(reading) {
    if (!reading) return;
    
    document.getElementById('voltageValue').textContent = reading.voltage.toFixed(2);
    document.getElementById('currentValue').textContent = reading.current.toFixed(3);
    document.getElementById('powerValue').textContent = reading.power.toFixed(2);
    document.getElementById('energyValue').textContent = reading.energy.toFixed(3);
    document.getElementById('frequencyValue').textContent = reading.frequency.toFixed(2);
    document.getElementById('pfValue').textContent = reading.power_factor.toFixed(3);
    
    const date = new Date(reading.timestamp);
    document.getElementById('lastUpdate').textContent = date.toLocaleString();
}

// Update device status
function updateDeviceStatus(device) {
    const statusEl = document.getElementById('deviceStatus');
    const isOnline = device.is_online;
    
    statusEl.innerHTML = `
        <span class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'} mr-2 pulse-animation"></span>
        ${isOnline ? 'Online' : 'Offline'}
    `;
}

// Update today's consumption
function updateTodayConsumption(consumption) {
    document.getElementById('todayConsumption').textContent = 
        `${consumption.toFixed(3)} kWh`;
}

// Initialize charts
function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        }
    };
    
    hourlyChart = new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Consumption (kWh)',
                data: [],
                backgroundColor: 'rgba(147, 51, 234, 0.5)',
                borderColor: 'rgba(147, 51, 234, 1)',
                borderWidth: 1
            }]
        },
        options: chartOptions
    });
    
    weeklyChart = new Chart(document.getElementById('weeklyChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Consumption (kWh)',
                data: [],
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: chartOptions
    });
}

// Update hourly chart
function updateHourlyChart(data) {
    const labels = data.map(d => `${d.hour}:00`);
    const values = data.map(d => d.consumption);
    
    hourlyChart.data.labels = labels;
    hourlyChart.data.datasets[0].data = values;
    hourlyChart.update();
}

// Update weekly chart
function updateWeeklyChart(data) {
    const labels = data.map(d => d.day);
    const values = data.map(d => d.consumption);
    
    weeklyChart.data.labels = labels;
    weeklyChart.data.datasets[0].data = values;
    weeklyChart.update();
}

// Update alerts
function updateAlerts(alerts) {
    const alertsList = document.getElementById('alertsList');
    
    if (alerts.length === 0) {
        alertsList.innerHTML = '<p class="text-gray-500 text-center py-4">No alerts</p>';
        return;
    }
    
    alertsList.innerHTML = alerts.map(alert => `
        <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 mb-3">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 font-medium">
                        ${alert.alert_type_display}
                    </p>
                    <p class="text-sm text-yellow-600 mt-1">
                        ${alert.message}
                    </p>
                    <p class="text-xs text-yellow-500 mt-1">
                        ${new Date(alert.created_at).toLocaleString()}
                    </p>
                </div>
            </div>
        </div>
    `).join('');
}

// Auto-update every 5 seconds
function startAutoUpdate() {
    updateInterval = setInterval(fetchDashboardData, 5000);
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}